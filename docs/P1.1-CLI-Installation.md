# P1.1 CLI Installation

**Status**: ✅ **COMPLETED**  
**Priority**: 1 (Core Session Tracking)  
**Test Date**: 2025-08-15

## Overview

The CLI Installation feature allows users to install the `tally` command globally on their system through a setup wizard interface.

## How It Works

### Setup Wizard Flow
1. **First Launch Detection**: App checks for `~/Library/Application Support/Tally/.setup_completed` file
2. **Setup Wizard Display**: If first launch, shows setup wizard overlay
3. **Installation Process**: User clicks "Install CLI Tools" button
4. **Symlink Creation**: Creates symlink from app bundle to `/usr/local/bin/tally`
5. **Completion Marking**: Creates `.setup_completed` file to prevent re-showing

### Technical Implementation

**Frontend** (`src/components/SetupWizard.tsx`):
```typescript
const handleInstall = async () => {
  setInstalling(true);
  try {
    const hasPermission = await invoke<boolean>('check_cli_permissions');
    if (!hasPermission) {
      throw new Error('Permission denied. Please use manual installation.');
    }
    await invoke('install_cli_globally');
    onComplete(); // Immediately go to main app
  } catch (err) {
    setError(err.toString());
    setShowManualInstructions(true);
  } finally {
    setInstalling(false);
  }
};
```

**Backend** (`src-tauri/src/lib.rs`):
```rust
#[tauri::command]
async fn install_cli_globally(app: AppHandle) -> Result<(), String> {
    let cli_source = if cfg!(debug_assertions) {
        // Development: use tools/tally from project
        std::env::current_dir()?.parent()?.join("tools").join("tally")
    } else {
        // Production: use bundled resource
        app.path().resource_dir()?.join("tally")
    };
    
    let cli_dest = Path::new("/usr/local/bin/tally");
    std::os::unix::fs::symlink(&cli_source, &cli_dest)?;
    mark_setup_completed()?;
    Ok(())
}
```

### File Locations

- **CLI Binary**: `/Users/kai/Development/tally/tools/tally` (development)
- **Installation Target**: `/usr/local/bin/tally`
- **Setup Flag**: `~/Library/Application Support/Tally/.setup_completed`

### User Experience

1. **Simplified Interface**: Clean, focused UI with single primary action
2. **No Skip Option**: Installation is mandatory for app functionality
3. **Manual Fallback**: Shows manual installation command if automatic fails
4. **Permission Handling**: Pre-checks write access and shows appropriate errors

### Error Handling

- **Permission Issues**: Shows manual installation instructions with `sudo` command
- **Binary Not Found**: Clear error message with file path
- **Directory Creation**: Attempts to create `/usr/local/bin` if missing

### Testing Results

- ✅ **Setup wizard appears** on first launch
- ✅ **Installation succeeds** when user has permissions
- ✅ **Manual fallback works** when permissions insufficient
- ✅ **Command available** after installation (`which tally` shows `/usr/local/bin/tally`)
- ✅ **Setup completion** - wizard doesn't re-appear on subsequent launches

### Dependencies

- **Tauri v2**: Path resolution and file operations
- **Unix symlinks**: `std::os::unix::fs::symlink` for CLI installation
- **Permission checking**: Write access validation to system directories

### Known Limitations

- **macOS only**: Uses Unix symlinks, not cross-platform
- **System permissions**: Requires write access to `/usr/local/bin`
- **Single IDE assumption**: Hardcoded to prefer Cursor over VS Code

### Future Improvements

- Cross-platform installation (Windows/Linux)
- User-selectable installation directory
- Automatic PATH detection and configuration
- Integration with package managers (Homebrew, etc.)