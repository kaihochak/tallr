# P1.3 Session Creation

**Status**: ✅ **COMPLETED**  
**Priority**: 1 (Core Session Tracking)  
**Test Date**: 2025-08-15

## Overview

Session Creation enables automatic task registration in the Tally dashboard when users run `tally claude`. The system detects project context and creates trackable sessions without manual intervention.

## How It Works

### Automatic Context Detection

When `tally claude` is executed, the wrapper automatically detects:

1. **Project Name**: From current directory name
2. **Repository Path**: Current working directory
3. **Agent Type**: From the command (`claude`)
4. **Session Title**: Generated description

**Environment Setup** (`tools/tally`):
```javascript
// Auto-detect project name from current directory
if (!env.TL_PROJECT) {
  const cwd = process.cwd();
  const projectName = cwd.split('/').pop() || 'unknown-project';
  env.TL_PROJECT = projectName;
}

// Set repo path to current directory
if (!env.TL_REPO) {
  env.TL_REPO = process.cwd();
}

// Set agent and title based on command
if (!env.TL_AGENT && args.length > 0) {
  env.TL_AGENT = args[0];  // 'claude'
}
if (!env.TL_TITLE && args.length > 0) {
  env.TL_TITLE = `${args[0]} session`;  // 'claude session'
}
```

### Task Creation Process

**Configuration** (`tools/tl-wrap.js`):
```javascript
const config = {
  token: process.env.TALLY_TOKEN || 'devtoken',
  gateway: 'http://127.0.0.1:4317',
  project: process.env.TL_PROJECT || 'default-project',
  repo: process.env.TL_REPO || process.cwd(),
  agent: process.env.TL_AGENT || 'cli',
  title: process.env.TL_TITLE || 'CLI Task',
  ide: process.env.TL_IDE || 'cursor'
};

const taskId = `${config.agent}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
```

**HTTP Request** (`tools/tl-wrap.js`):
```javascript
async function createTask() {
  await makeRequest('POST', '/v1/tasks/upsert', {
    project: {
      name: config.project,        // 'tally' (from directory)
      repoPath: config.repo,       // '/Users/kai/Development/tally'
      preferredIDE: config.ide     // 'cursor'
    },
    task: {
      id: taskId,                  // 'claude-1755199460426-aij6p10mr'
      agent: config.agent,         // 'claude'
      title: config.title,         // 'claude session'
      state: 'RUNNING'             // Initial state
    }
  });
}
```

### Backend Processing

**Rust Handler** (`src-tauri/src/lib.rs`):
```rust
#[tauri::command]
async fn upsert_task(req: UpsertTaskRequest) -> Result<(), String> {
    let mut store = STORE.lock();
    
    // Create or update project
    let project_id = format!("{}#{}", req.project.name, req.project.repo_path);
    store.projects.insert(project_id.clone(), req.project);
    
    // Create task with project reference
    let mut task = req.task;
    task.project_id = project_id;
    task.last_event_at = SystemTime::now()
        .duration_since(UNIX_EPOCH)
        .unwrap()
        .as_secs();
    
    store.tasks.insert(task.id.clone(), task);
    
    // Emit event for real-time UI updates
    if let Some(app_handle) = &*APP_HANDLE.lock() {
        app_handle.emit("tasks-updated", &*store).ok();
    }
    
    Ok(())
}
```

### Real-time Dashboard Updates

**Frontend State Management** (`src/App.tsx`):
```typescript
useEffect(() => {
  const unlisten = listen<AppState>('tasks-updated', (event) => {
    setAppState(event.payload);
  });
  return () => { unlisten.then(fn => fn()); };
}, []);
```

**Task Display** (`src/App.tsx`):
```tsx
{filteredTasks.map((task, index) => {
  const project = appState.projects[task.projectId];
  return (
    <div className={`task-row state-${task.state.toLowerCase()}`}>
      <span className="project-name">{project?.name}</span>
      <span className="task-title">{task.title}</span>
      <span className="task-state">{task.state}</span>
    </div>
  );
})}
```

### User Experience Flow

1. **User runs command**:
   ```bash
   cd ~/my-project
   tally claude
   ```

2. **Immediate feedback**:
   ```
   [Tally] Created task claude-1755199460426-aij6p10mr for my-project
   ```

3. **Dashboard appearance**:
   - Task appears as "my-project - claude session"
   - State shows as "RUNNING"
   - Real-time updates as state changes

### Testing Results

**✅ Automatic Detection**:
- Project name correctly extracted from directory
- Repository path set to current working directory
- Agent type determined from command name

**✅ Task Creation**:
- HTTP request successfully sent to gateway
- Task appears in Tally dashboard immediately
- Unique task ID generated for each session

**✅ Real-time Updates**:
- Tasks appear within ~100ms of command execution
- Dashboard reflects current session state
- Multiple concurrent sessions supported

### Configuration Options

**Environment Variables**:
```bash
export TL_PROJECT="Custom Project Name"    # Override project name
export TL_REPO="/custom/path"              # Override repo path
export TL_IDE="vscode"                     # Override preferred IDE
export TALLY_TOKEN="custom-token"          # Override auth token
```

**Example Custom Usage**:
```bash
TL_PROJECT="My Custom Project" tally claude
# Creates task: "My Custom Project - claude session"
```

### Error Handling

**Network Failures**:
```javascript
try {
  await makeRequest('POST', '/v1/tasks/upsert', taskData);
  console.log(`[Tally] Created task ${taskId} for ${config.project}`);
} catch (error) {
  console.error(`[Tally] Failed to create task:`, error.message);
  // Claude continues normally even if Tally tracking fails
}
```

**Invalid Configuration**:
- Fallback values ensure task creation always succeeds
- Missing environment variables use sensible defaults
- Malformed data gracefully handled by backend validation

### Dependencies

- **HTTP Client**: Node.js built-in `http` module
- **Tauri Backend**: Rust Axum server for task storage
- **Real-time Events**: Tauri event system for UI updates

### Known Limitations

- **Single project detection**: Uses directory name only
- **No Git integration**: Doesn't detect actual repo information
- **Memory storage**: Tasks lost on app restart (persistence pending)
- **Simple naming**: Project names based on directory, not repo name

### Future Improvements

- Git repository detection for accurate project names
- Persistent storage to survive app restarts
- Project deduplication (reuse existing projects)
- Custom project configuration files
- Integration with IDEs for better context detection