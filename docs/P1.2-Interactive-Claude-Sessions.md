# P1.2 Interactive Claude Sessions

**Status**: ✅ **COMPLETED**  
**Priority**: 1 (Core Session Tracking)  
**Test Date**: 2025-08-15

## Overview

The Interactive Claude Sessions feature ensures that `tally claude` provides the exact same experience as running `claude` directly, preserving all Claude CLI functionality while adding session tracking.

## How It Works

### PTY (Pseudo-Terminal) Implementation

The key breakthrough was using **node-pty** instead of standard `child_process.spawn()` to maintain full terminal interactivity.

**Problem with Standard Approach**:
```javascript
// BROKEN: This breaks Claude's interactive mode
spawn('claude', args, { stdio: ['inherit', 'pipe', 'pipe'] });
// Claude detects non-TTY and falls back to --print mode
```

**PTY Solution**:
```javascript
// WORKING: This preserves full interactivity
const ptyProcess = pty.spawn('claude', [], {
  name: 'xterm-color',
  cols: process.stdout.columns || 80,
  rows: process.stdout.rows || 30,
  cwd: process.cwd(),
  env: process.env
});
```

### Technical Implementation

**Detection Logic** (`tools/tl-wrap.js`):
```javascript
function needsInteractiveMode(command, args) {
  const interactiveCLIs = ['claude', 'gemini', 'cursor-composer'];
  return interactiveCLIs.includes(command);
}
```

**PTY Wrapper** (`tools/tl-wrap.js`):
```javascript
async function runWithPTY(command, commandArgs) {
  const ptyProcess = pty.spawn(command, commandArgs, {
    name: 'xterm-color',
    cols: process.stdout.columns || 80,
    rows: process.stdout.rows || 30,
    cwd: process.cwd(),
    env: process.env
  });

  // Monitor output while preserving display
  ptyProcess.on('data', (data) => {
    process.stdout.write(data);  // User sees output
    processLine(data);           // Tally monitors patterns
  });

  // Forward user input safely
  if (process.stdin.setRawMode && process.stdin.isTTY) {
    process.stdin.setRawMode(true);
    process.stdin.on('data', (data) => {
      ptyProcess.write(data);
    });
  }
}
```

### Preserved Claude Features

**✅ Full UI Preservation**:
- Welcome boxes with Unicode art: `╭───────────────╮`
- Interactive prompts: `> Try "fix lint errors"`
- Real-time indicators: `⏺`, `⏸`, thinking dots
- Color formatting and ANSI codes
- Status bar: `⧉ In file.js`, model switching alerts

**✅ All Claude CLI Commands**:
- Interactive chat sessions
- Slash commands: `/help`, `/status`, `/clear`
- Continuation: `claude -c`, `claude -r [sessionId]`
- Model selection: `claude --model sonnet`
- File operations and @-tagging

**✅ Native Keyboard Interaction**:
- Real-time typing and editing
- Terminal shortcuts (Ctrl+C, Ctrl+L, etc.)
- Arrow key navigation
- Tab completion where available

### Error Handling

**Raw Mode Safety**:
```javascript
// Only enable raw mode if available
if (process.stdin.setRawMode && process.stdin.isTTY) {
  process.stdin.setRawMode(true);
  // ... setup input forwarding
  
  // Always restore on exit
  process.on('exit', () => {
    if (process.stdin.setRawMode && process.stdin.isTTY) {
      process.stdin.setRawMode(false);
    }
  });
}
```

**Graceful Fallback**:
```javascript
// If PTY fails, fall back to standard spawn
async function runWithSpawn(command, commandArgs) {
  const { spawn } = await import('child_process');
  const child = spawn(command, commandArgs, {
    stdio: ['inherit', 'pipe', 'pipe']
  });
  // ... traditional monitoring
}
```

### Testing Results

**✅ Interactive Experience**:
- Claude shows normal welcome screen
- All UI elements display correctly (boxes, colors, status)
- User can type questions and get responses
- Real-time streaming works perfectly

**✅ Feature Compatibility**:
- `/help` command works normally
- Model switching notifications appear
- File context detection functions
- Continue/resume sessions work

**✅ Performance**:
- No noticeable latency compared to native `claude`
- Memory usage remains similar
- CPU usage patterns identical

### Dependencies

- **node-pty**: `npm install node-pty` for pseudo-terminal functionality
- **Platform-specific**: Currently macOS/Unix only
- **Terminal environment**: Requires TTY support for full functionality

### Architecture Benefits

**Hybrid Approach**:
- **PTY for interactive CLIs**: Claude, Gemini, other AI tools
- **Standard spawn for utilities**: grep, curl, simple commands
- **Automatic detection**: Based on command name
- **Consistent monitoring**: Same pattern detection for both approaches

### Known Limitations

- **Platform dependency**: PTY requires Unix-like systems
- **Terminal assumption**: Assumes terminal supports raw mode
- **Process cleanup**: Complex signal handling required
- **Memory overhead**: PTY adds slight memory cost vs direct spawn

### Future Improvements

- Cross-platform PTY support (Windows pty)
- Better terminal capability detection
- Configurable CLI detection (user-defined interactive commands)
- Performance optimization for high-output scenarios