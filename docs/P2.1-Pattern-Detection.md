# P2.1 Pattern Detection

**Status**: ✅ **COMPLETED**  
**Priority**: 2 (Notification System)  
**Test Date**: 2025-08-15

## Overview

Pattern Detection monitors Claude CLI output streams to identify specific events that trigger notifications: approval prompts ("Approve? [y/N]"), error conditions, and state changes.

## How It Works

### Output Stream Monitoring

**PTY Data Processing** (`tools/tl-wrap.js`):
```javascript
let outputBuffer = '';

ptyProcess.on('data', (data) => {
  process.stdout.write(data);  // User sees real-time output
  outputBuffer += data;
  
  // Process complete lines for pattern matching
  const lines = outputBuffer.split('\n');
  outputBuffer = lines.pop() || '';
  
  lines.forEach(line => {
    const cleanLine = cleanANSI(line);
    detectPatterns(cleanLine);
  });
});
```

**ANSI Code Removal**:
```javascript
function cleanANSI(text) {
  // Remove color codes, cursor movements, etc.
  return text
    .replace(/\x1b\[[0-9;]*m/g, '')      // Color codes
    .replace(/\x1b\[[0-9;]*[A-Za-z]/g, '') // Cursor commands
    .replace(/\r/g, '')                   // Carriage returns
    .trim();
}
```

### Current Pattern Detection

**Generic Patterns** (`tools/tl-wrap.js`):
```javascript
function detectPatterns(line) {
  // Approval prompts
  if (line.includes('Approve? [y/N]')) {
    triggerNotification('WAITING_USER', 'Claude needs approval', line);
    updateTaskState('WAITING_USER', line);
    return;
  }
  
  // Error detection
  if (line.includes('Error:') || line.includes('error:')) {
    triggerNotification('ERROR', 'Claude encountered an error', line);
    updateTaskState('ERROR', line);
    return;
  }
  
  // Success patterns
  if (line.includes('✓') || line.includes('Success')) {
    updateTaskState('RUNNING', line);
    return;
  }
}
```

### Notification Triggering

**Desktop Notification System**:
```javascript
async function triggerNotification(type, title, details) {
  const notificationData = {
    title: title,
    body: details.length > 100 ? details.substring(0, 100) + '...' : details,
    icon: getIconForType(type),
    tag: `tally-${taskId}`,
    data: {
      taskId: taskId,
      projectPath: config.repo,
      type: type
    }
  };
  
  try {
    // Send to Tally for Mac notification
    await makeRequest('POST', '/v1/notifications/trigger', notificationData);
  } catch (error) {
    console.error('[Tally] Notification failed:', error);
  }
}
```

## Issues with Current Implementation

### 1. Claude-Specific Patterns Missing

**What Claude actually outputs**:
```bash
# Approval prompts (various formats)
"Apply these changes? [y/N]"
"Approve? [y/N]" 
"Continue with this approach? [y/N]"
"Proceed? [y/N]"

# Thinking indicators
"⏺ Thinking..."
"⏺ Analyzing your code..."
"⏺ Processing request..."

# Response indicators  
"⏸ Here's what I found:"
"⏸ I can help with that:"

# Error patterns
"❌ I encountered an error:"
"⚠️ Warning: This approach might..."
"Error: Unable to access file"
"Failed to execute command"

# Tool usage
"🔧 Running command: npm test"
"📁 Reading file: src/app.js"
"✏️ Writing to file: config.json"
```

### 2. Complex ANSI Handling

**Real Claude output includes**:
```javascript
// Raw data example:
"\x1b[2K\r⏺ \x1b[36mThinking about your request...\x1b[0m\x1b[K"

// Current cleaning misses:
// - Cursor positioning (\x1b[2K\r)
// - Complex color sequences
// - Unicode symbols mixed with ANSI
```

**Improved ANSI cleaning needed**:
```javascript
function cleanANSI(text) {
  return text
    // Clear line commands
    .replace(/\x1b\[2K/g, '')
    .replace(/\x1b\[K/g, '')
    // Cursor positioning
    .replace(/\x1b\[[0-9]+;[0-9]+H/g, '')
    .replace(/\x1b\[[0-9]+[ABCD]/g, '')
    // Color and style codes
    .replace(/\x1b\[[0-9;]*m/g, '')
    // Carriage returns and tabs
    .replace(/\r/g, '')
    .replace(/\t/g, ' ')
    // Multiple spaces
    .replace(/\s+/g, ' ')
    .trim();
}
```

### 3. Context-Aware Detection

**Current issue**: No context awareness
```javascript
// False positive example:
"I see you're getting an 'Error: Invalid token' message"
// ❌ Triggers error notification incorrectly

// Need context-aware patterns:
function detectWithContext(line, previousLines, currentState) {
  // Only trigger on actual Claude errors, not quoted errors
  if (currentState === 'THINKING' && line.startsWith('❌')) {
    return 'ERROR';
  }
  // etc.
}
```

## Claude-Specific Patterns Needed

### 1. Approval Prompts
```javascript
const approvalPatterns = [
  /Apply\s+(?:these\s+)?changes\?\s*\[y\/N\]/i,
  /Approve\?\s*\[y\/N\]/i,
  /Continue\s+(?:with\s+)?(?:this\s+)?(?:approach\?)?\s*\[y\/N\]/i,
  /Proceed\?\s*\[y\/N\]/i,
  /Confirm\?\s*\[y\/N\]/i,
  /Execute\s+(?:this\s+)?(?:command\?)?\s*\[y\/N\]/i
];
```

### 2. State Indicators
```javascript
const statePatterns = {
  thinking: [
    /⏺\s+Thinking/i,
    /⏺\s+Analyzing/i,
    /⏺\s+Processing/i,
    /⏺\s+Working/i
  ],
  responding: [
    /⏸\s+Here's/i,
    /⏸\s+I can/i,
    /⏸\s+Let me/i,
    /⏸\s+Based on/i
  ],
  error: [
    /❌\s+(?:I\s+)?(?:encountered\s+)?(?:an\s+)?error/i,
    /Error:\s+/,
    /Failed\s+to\s+/i,
    /Unable\s+to\s+/i,
    /Cannot\s+/i
  ]
};
```

### 3. Tool Usage Detection
```javascript
const toolPatterns = {
  reading: [/📁\s+Reading\s+file:\s+(.+)/],
  writing: [/✏️\s+Writing\s+to\s+file:\s+(.+)/],
  executing: [/🔧\s+Running\s+command:\s+(.+)/],
  searching: [/🔍\s+Searching\s+for:\s+(.+)/]
};
```

## Testing Requirements

### 1. Pattern Accuracy Testing

**Test each pattern type**:
```bash
# Manual testing script
tally claude

# Test approval detection
> help me refactor this code
# Wait for "Apply these changes? [y/N]"
# Verify: Notification appears immediately
# Verify: Dashboard shows WAITING_USER state

# Test error detection  
> access a non-existent file
# Wait for "❌ Error: File not found"
# Verify: Error notification appears
# Verify: Dashboard shows ERROR state

# Test thinking detection
> explain this complex algorithm
# Wait for "⏺ Thinking..."
# Verify: Dashboard shows THINKING state
```

### 2. False Positive Prevention

**Anti-patterns testing**:
```bash
# Should NOT trigger notifications:
> I'm getting an "Error: Invalid token" message  # Quoted error
> The function returns "Approve? [y/N]" prompt    # Quoted prompt
> Let's test the "⏺ Thinking" indicator          # Quoted indicator
```

### 3. Real-world Scenario Testing

**Complex interactions**:
```bash
# Multi-step approval workflow
tally claude
> help me migrate this database
# ⏺ Thinking... (should detect)
# ⏸ I'll help with that (should detect)
# Apply migration step 1? [y/N] (should notify)
y
# 🔧 Running command: npm run migrate (should detect tool usage)
# ✓ Migration complete (should detect success)
# Apply migration step 2? [y/N] (should notify again)
```

## Performance Considerations

### 1. Pattern Matching Efficiency
```javascript
// Optimize pattern matching for real-time streams
class PatternMatcher {
  constructor() {
    this.compiledPatterns = new Map();
    this.precompilePatterns();
  }
  
  precompilePatterns() {
    // Pre-compile all regex patterns
    approvalPatterns.forEach(pattern => {
      this.compiledPatterns.set('approval', pattern);
    });
  }
  
  match(line) {
    // Fast matching with compiled patterns
    // Early return on first match
    // Minimize regex operations
  }
}
```

### 2. Buffer Management
```javascript
// Prevent memory leaks from large output streams
class OutputBuffer {
  constructor(maxLines = 1000) {
    this.lines = [];
    this.maxLines = maxLines;
  }
  
  addLine(line) {
    this.lines.push(line);
    if (this.lines.length > this.maxLines) {
      this.lines.shift(); // Remove oldest line
    }
  }
}
```

## Error Handling

### 1. Pattern Match Failures
```javascript
try {
  const matches = detectPatterns(line);
  if (matches.length > 0) {
    await processMatches(matches);
  }
} catch (error) {
  console.error('[Tally] Pattern detection failed:', error);
  // Continue processing - don't break the CLI wrapper
}
```

### 2. Notification Delivery Failures
```javascript
async function triggerNotification(type, title, details) {
  try {
    await makeRequest('POST', '/v1/notifications/trigger', notificationData);
  } catch (error) {
    console.error('[Tally] Notification failed:', error);
    // Log failure but don't interrupt Claude session
    logNotificationFailure(type, title, error);
  }
}
```

## Dependencies

### Required Libraries
- **RegExp engine**: For pattern compilation and matching
- **ANSI parser**: For robust terminal output cleaning
- **Buffer management**: For handling large output streams

### Integration Points
- **P1.4 State Tracking**: Provides state updates based on detected patterns
- **P2.2 Mac Notifications**: Receives trigger events from pattern detection
- **PTY wrapper**: Source of all output data to analyze

## Success Criteria

**✅ Ready when**:
- Detects Claude approval prompts with 95%+ accuracy
- No false positives from quoted text or normal conversation
- Real-time pattern matching (< 100ms latency)
- Handles all Claude UI indicators (⏺, ⏸, ❌, ✓, 🔧, etc.)
- Robust ANSI code handling for clean text extraction
- Error recovery prevents pattern failures from breaking Claude sessions

## Current Status

**✅ COMPLETED**: Full Claude-specific implementation working
- ✅ Claude-specific pattern detection implemented and tested
- ✅ Advanced ANSI cleaning handles Claude UI complexity  
- ✅ State transition tracking with confidence levels
- ✅ Context-aware pattern matching prevents false positives
- ✅ Debug logging for pattern analysis and troubleshooting
- ✅ Successfully detects all Claude states: IDLE, THINKING, WAITING_FOR_APPROVAL, ERROR